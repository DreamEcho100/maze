
# @de100/env Documentation

This library provides type-safe and runtime-validated access to your environment variables for Next.js (and similar) projects. It’s built on the core ideas of environment validation from popular projects (like T3 Env) and supports any [Standard Schema–compliant validator](https://standardschema.dev/) (for example, Zod or Standard Schema). This ensures your environment is correctly configured at build and runtime while keeping server-only secrets secure.

## Notes

- This is based on [@t3-oss/env-nextjs](https://github.com/t3-oss/t3-env).
- Docs generated by chatGPT.

---

## Table of Contents

- [Overview](#overview)
- [Key Features](#key-features)
- [Installation](#installation)
- [Usage](#usage)
  - [Basic Setup](#basic-setup)
  - [Environment Schemas](#environment-schemas)
- [Configuration Options](#configuration-options)
- [Error Handling & Access Control](#error-handling--access-control)
- [Advanced Topics](#advanced-topics)
- [Example](#example)
- [FAQ](#faq)
- [License](#license)

---

## Overview

**@de100/env** enables you to:

- **Achieve Type Safety:**  
  Define distinct schemas for server, client, and shared environment variables using advanced TypeScript generics. The types are automatically inferred, ensuring your environment variables are correctly used throughout your code.

- **Validate at Runtime:**  
  Validate environment variables using any Standard Schema–compliant validator (such as [Zod](https://github.com/colinhacks/zod) or [Standard Schema](https://standardschema.dev/)). This catches misconfigurations early, reducing runtime errors.

- **Enforce Client/Server Separation:**  
  Ensure server-only variables remain protected and are not accidentally exposed on the client side.

- **Customize Behavior:**  
  Options like skipping validation (useful for CI/CD or linting) and treating empty strings as `undefined` give you control over how environments are processed.

---

## Key Features

- **Type-Safe Definitions:**  
  Separate schemas for server, client, and shared variables. Client variables must be prefixed (e.g., `NEXT_PUBLIC_`) to avoid accidentally exposing sensitive data.

- **Flexible Validator Support:**  
  Built on the Standard Schema specification, **@de100/env** works with any validator that meets the standard. This means you can use Zod or another compliant library without changing your code.  
  [Learn more about Standard Schema here](https://standardschema.dev/).

- **Synchronous Validation:**  
  The synchronous validation function (`parseWithDictionary`) checks each environment variable against its defined schema before your application runs, ensuring any misconfiguration is caught immediately.

- **Custom Callbacks for Errors & Access:**  
  - **`onValidationError`:** Triggered when validation fails, so you can log issues or halt execution as needed.  
  - **`onInvalidAccess`:** Invoked when there’s an attempt to access a server-only variable on the client side.

- **Runtime Environment Merging:**  
  Combine multiple sources of environment variables—including additional extended schemas—into a unified environment object.

- **Proxy-Based Security:**  
  A JavaScript Proxy wraps the final environment object, intercepting access to prevent client-side code from retrieving server-only variables.

- **Flexible Options:**  
  Options such as `emptyStringAsUndefined` and `skipValidation` provide extra control in different environments.

---

## Installation

Install **@de100/env** along with your validator of choice. For example, using pnpm:

```bash
pnpm add @de100/env zod
```

> **Note:** This package is designed for Next.js environments but is adaptable to other projects. It supports any Standard Schema–compliant validator.

---

## Usage

### Basic Setup

1. **Create your environment schema file (e.g., `src/env.ts`):**

    ```ts
    import { createEnv } from '@de100/env';
    import { z } from 'zod'; // Or import from your Standard Schema library

    export const env = createEnv({
      // Server-only variables (not available on the client)
      server: {
        DATABASE_URL: z.string().url(),
        OPEN_AI_API_KEY: z.string().min(1),
      },
      // Client-only variables (must be prefixed, e.g., NEXT_PUBLIC_)
      client: {
        NEXT_PUBLIC_CLIENTVAR: z.string(),
      },
      // Shared variables available on both server and client
      shared: {
        NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
      },
      // Explicitly provide runtime variables (important for Next.js bundling)
      experimental__runtimeEnv: {
        NODE_ENV: process.env.NODE_ENV,
        NEXT_PUBLIC_CLIENTVAR: process.env.NEXT_PUBLIC_CLIENTVAR,
      },
      // Optional configuration:
      skipValidation: !!process.env.SKIP_ENV_VALIDATIONS,
      emptyStringAsUndefined: true,
    });
    ```

2. **Use the validated environment variables in your application:**

    ```ts
    // In a Next.js API route or server file:
    import { env } from '../env';

    export async function GET() {
      const dbUrl = env.DATABASE_URL; // Type-safe and validated
      // Use dbUrl in your database connection logic
    }
    ```

### Environment Schemas

- **Server:**  
  Define variables that are meant solely for the server side (e.g., database URLs, API keys).

- **Client:**  
  Define variables that are safe for client exposure. These must be prefixed (commonly with `NEXT_PUBLIC_`).

- **Shared:**  
  Define variables accessible on both the client and server (e.g., `NODE_ENV`).

---

## Configuration Options

- **`skipValidation`**  
  *Type:* `boolean`  
  *Description:* When `true`, the validation step is bypassed. This is useful in CI/CD pipelines or during linting where not all environment variables are set.

- **`emptyStringAsUndefined`**  
  *Type:* `boolean`  
  *Description:* Converts empty string values (`""`) to `undefined`, helping to differentiate between “not set” and “intentionally empty.”

- **`experimental__runtimeEnv`**  
  *Type:* `Partial<Record<string, string | boolean | number | undefined>>`  
  *Description:* Manually extracts variables from `process.env` to ensure they are bundled in client-side code—essential for Next.js versions that require explicit declaration for client variables.

- **`onValidationError`**  
  *Type:* `(issues: unknown[]) => void`  
  *Description:* Callback invoked when environment variable validation fails. The default behavior logs issues and throws an error.

- **`onInvalidAccess`**  
  *Type:* `(key: string) => void`  
  *Description:* Callback triggered when there is an attempt to access a server-only variable on the client. The default action throws an error to protect sensitive data.

- **`extends`**  
  *Type:* `Array<Record<string, StandardSchemaV1>>`  
  *Description:* Allows additional configuration objects to be merged into the final environment object, useful for integrating settings from external modules or libraries.

---

## Error Handling & Access Control

- **Validation Errors:**  
  Each variable is validated against its defined schema during initialization. If validation fails, the `onValidationError` callback is executed.

- **Unauthorized Access:**  
  The environment object is wrapped in a Proxy. If client-side code tries to access a server-only variable, the `onInvalidAccess` callback is triggered, ensuring sensitive data isn’t exposed.

---

## Advanced Topics

### Extending Schemas

Merge additional configuration objects using the `extends` option. This is useful for incorporating settings from multiple sources into one unified environment object.

### Customizing Error Messages

The advanced TypeScript generics enforce that client variables follow the required prefix. A compile-time error is generated with a custom message if a client variable does not adhere to the naming convention.

### Proxy Interception

The final environment object is wrapped in a Proxy to:

- Prevent client-side access to server-only variables.
- Exclude special properties (e.g., `__esModule` or `$$typeof`).

---

## Example

Here’s a complete example demonstrating how to set up and use **@de100/env**:

```ts
// src/env.ts
import { createEnv } from '@de100/env';
import { z } from 'zod'; // Alternatively, use your Standard Schema library

export const env = createEnv({
  server: {
    DATABASE_URL: z.string().url(),
    OPEN_AI_API_KEY: z.string().min(1),
  },
  client: {
    NEXT_PUBLIC_CLIENTVAR: z.string(),
  },
  shared: {
    NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  },
  experimental__runtimeEnv: {
    NODE_ENV: process.env.NODE_ENV,
    NEXT_PUBLIC_CLIENTVAR: process.env.NEXT_PUBLIC_CLIENTVAR,
  },
  skipValidation: !!process.env.SKIP_ENV_VALIDATIONS,
  emptyStringAsUndefined: true,
});
```

And in a Next.js API route:

```ts
// pages/api/hello.ts
import { env } from '../../src/env';

export default function handler(req, res) {
  const dbUrl = env.DATABASE_URL;
  res.status(200).json({ database: dbUrl });
}
```

---

## FAQ

### Why must client variables be prefixed?

Client variables are required to have a prefix (typically `NEXT_PUBLIC_`) to prevent the accidental exposure of sensitive data on the client side.

### What happens if validation fails?

By default, if validation fails, the library logs the issues and throws an error via the `onValidationError` callback. You can override this behavior by providing your own callback.

### Can I bypass validation?

Yes—by setting `skipValidation` to `true`. However, bypassing validation in production is discouraged as it may lead to runtime errors if the environment is misconfigured.

### Which validators are supported?

Any validator that conforms to the [Standard Schema](https://standardschema.dev/) specification is supported. You can use Zod, Standard Schema, or any other compliant library without needing to modify your code.

---

## License

This library is released under the MIT License.

---

*This documentation is based on an implementation inspired by modern environment validation practices and leverages the Standard Schema specification. For more details, please refer to the official resources and community examples.*
